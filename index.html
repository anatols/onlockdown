<!DOCTYPE html>
<html>
    <head>
        <title>Locked down</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
        <link rel="manifest" href="site.webmanifest">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reenie+Beanie">
        <meta name="viewport" content="width=600, initial-scale=0.5">
        <script type="text/javascript" src="countrydata.js"></script>
        <script>
            function tallyMarks(count) {
                function generateTallyMark(number) {
                    const outerSpan = document.createElement("span");
                    outerSpan.style.display = "inline-block";

                    for (let i = 0; i < number; i++)
                    {
                        const span = document.createElement("span");
                        span.style.display = "inline-block";
                        if (i == 4) {
                            span.innerHTML = "/"
                            span.style.transform = `scaleX(2.5) translateX(${ -15 - Math.random() * 3 }px) translateY(${ Math.random() * 3 }px) rotate(${ Math.random() * 20 }deg)`;
                        }
                        else {
                            span.innerHTML = "l"
                            span.style.transform = `skewX(${ -Math.random() * 20 }deg) translateX(${ Math.random() * 3 }px) translateY(${ Math.random() * 3 }px)`;
                        }

                        outerSpan.appendChild(span);
                    }
                    return outerSpan;
                };

                const result = [];
                for (let i = 0; i < count / 5; i++) {
                    result.push(generateTallyMark(5));
                    result.push(document.createTextNode(" "));
                }

                const remainder = count % 5;
                if (remainder != 0)
                {
                    result.push(generateTallyMark(remainder));
                }

                return result;
            };

            function countryDropdownItems() {
                return Object.keys(countryData)
                    .sort()
                    .map(countryCode => {
                        const anchor = document.createElement("a");
                        anchor.className = "dropdown-item text-muted country-dropdown-item";
                        anchor.innerText = countryData[countryCode]["name"];
                        anchor.addEventListener('click', () => {
                            displayCountry(countryCode);
                        });
                        return anchor;
                    });
            }

            function displayCountry(countryCode) {
                if (!(countryCode in countryData)) {
                    countryCode = "US";
                }

                const dropdownButton = document.querySelector("#country-dropdown-menu-button");
                dropdownButton.innerText = countryData[countryCode]["name"];

                const startDate = new Date(countryData[countryCode]["start"]);
                const endDate = new Date();
                let stillOnLockdown = true;
                if ("end" in countryData[countryCode]) {
                    endDate = new Date(countryData[countryCode]["end"]);
                    stillOnLockdown = false;
                }

                const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

                const lockdownText = document.querySelector("#lockdown-text");
                if (stillOnLockdown) {
                    lockdownText.innerText = ` on lockdown since ${ startDate.toLocaleDateString() }`;
                }
                else {
                    lockdownText.innerText = ` was on lockdown from ${ startDate.toLocaleDateString() } till ${ endDate.toLocaleDateString() }`;
                }

                const tallyContainer = document.querySelector("#tally");
                tallyContainer.innerHTML = "";
                tallyMarks(durationDays).forEach(element => tallyContainer.appendChild(element));

                document.querySelector("#total").innerHTML = durationDays + " day" + (durationDays > 1 ? "s" : "");
            }

            function detectAndDisplayCountry() {
                fetch("http://ip-api.com/json/?fields=countryCode")
                .then((response) => response.json())
                .then((result) => {
                    if ("countryCode" in result) {
                        displayCountry(result["countryCode"]);
                    }
                    else {
                        displayCountry("");
                    }
                })
                .catch((error) => {
                    displayCountry("");
                });
            }

            document.addEventListener("DOMContentLoaded", event => {
                const dropdownItems = document.querySelector("[aria-labelledby=\"country-dropdown-menu-button\"]");
                dropdownItems.innerHTML = "";
                countryDropdownItems().forEach(element => dropdownItems.appendChild(element));
                detectAndDisplayCountry();
            });
        </script>
        <style type="text/css">
            #heading {
                font-family: 'Reenie Beanie', fantasy;
                font-size: 60px;
                text-align: center;
                padding-top: 120px;
                padding-bottom: 70px;
            }

            #total {
                font-family: 'Reenie Beanie', fantasy;
                font-size: 40px;
                width: 600px;
                padding-top: 120px;
                margin: 0 auto;
                text-align: right;
                transform: rotate(-30deg);
            }

            #country-dropdown-menu-button {
                border-style: none;
            }

            #country-dropdown-menu-button:after {
                padding: 0;
                opacity: 50%;
                font-size: 20px;
            }

            .country-dropdown-item {
                font-size: 30px;
            }

            .tally-tick {
                display:inline-block;
            }

            .tally-strike {
                display:inline-block;
                transform: scaleX(2.0) translateX(10px);
            }

            #tally {
                user-select: none;
                font-family: 'Reenie Beanie', fantasy;
                font-size: 80px;
                width: 600px;
                margin: 0 auto;
            }

            .lds-dual-ring {
                display: inline-block;
                width: 80px;
                height: 80px;
            }
            .lds-dual-ring:after {
                content: " ";
                display: block;
                width: 64px;
                height: 64px;
                margin: 8px;
                border-radius: 50%;
                border: 6px solid #6C757D;
                border-color: #6C757D transparent #6C757D transparent;
                animation: lds-dual-ring 1.2s linear infinite;
            }
            @keyframes lds-dual-ring {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body class="bg-dark text-muted">
        <div class="container">
            <div id="heading">
                <div class="dropdown" style="display: inline-block;" id="country-dropdown">
                    <button class="dropdown-toggle bg-dark text-muted" type="button" id="country-dropdown-menu-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="lds-dual-ring"></div>
                    </button>
                    <div class="dropdown-menu bg-dark text-muted" aria-labelledby="country-dropdown-menu-button">
                    </div>
                </div>
                <span id="lockdown-text"></span>
            </div>
            <div id="tally"></div>
            <div id="total"></div>
        </div>
    </body>
</html>
